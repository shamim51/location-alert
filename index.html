<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Alert</title>

    <!-- Leaflet library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
    crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
    crossorigin=""></script>

    
    <link rel="manifest" href="app.webmanifest">

    <script src="sw-register.js"></script>

    <!-- Leaflet Geofence plugin -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet-geofence@1.0.1/dist/leaflet-geofence.min.css" />

    <script src="https://unpkg.com/leaflet-geofence@1.0.1/dist/leaflet-geofence.min.js"></script> -->

    <link rel="stylesheet" href="style.css">

</head>
<body>
    <div id="map"></div>
    <button onclick="getLocation()">Grant Location Access</button>

</body>

<script>

    var initialMarker;

    navigator.geolocation.getCurrentPosition((position)=>{
       initialMarker = L.marker([position.coords.latitude, position.coords.longitude]).addTo(map);
    }, (err)=>{
        console.log("hello");
    });
    var map = L.map('map').setView([23.788212, 90.399971], 13);

    var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxNativeZoom: 19, 
    maxZoom: 20 }).addTo(map);

    // var circle = L.geofence.circle([23.788212, 90.399971], 500, {
    //     fillColor: '#ff0000',
    //     fillOpacity: 0.2,
    //     stroke: false
    // }).addTo(map);

    // circle.on('enter', function () {
    //     alert('You have entered the geofenced area');
    // });

    // circle.on('exit', function () {
    //     alert('You have exited the geofenced area');
    // });

    

   
    var ignitor = 0;

    var desMarker;
    var currentLocationMarker;

    var circle;




    var current_lat, current_lng;
    var e_lat, e_lng;



    function getLocation() {
  // Check if geolocation is supported
        if (navigator.geolocation) {
            // Request permission to access user's location
            navigator.permissions.query({name:'geolocation'}).then(function(result) {
            if (result.state === 'granted') {
                // If permission is granted, continuously watch user's position
                console.log("granted");
                navigator.geolocation.watchPosition(success, error);
            } else if (result.state === 'prompt') {
                // If permission is not granted or denied, prompt user to grant permission
                navigator.geolocation.getCurrentPosition(success, error);
            } else if (result.state === 'denied') {
                // If permission is denied, show an error message to the user
                console.log('Geolocation permission denied');
            }
            });
        } else {
            // If geolocation is not supported, show an error message to the user
            console.log('Geolocation is not supported by this browser');
        }
    }

    /*
    function success(position) {
        // Update user's position on the map
    }

    function error(error) {
        // Show an error message to the user
    }*/

    // Call getLocation() function to request permission and watch user's position
    //getLocation();


    // function getLocation() {
    //     navigator.geolocation.getCurrentPosition(success, error);
    // }



    function success(pos){
        //let lat, lng;
        current_lat = pos.coords.latitude;
        console.log("current latitude: " + current_lat);
        
        current_lng = pos.coords.longitude;
        console.log("current longtitude: "+current_lng);

        const accuracy = pos.coords.accuracy;
        //console.log(accuracy);

        console.log("ignitor: "+ignitor);

        if(initialMarker){
            map.removeLayer(initialMarker);
        }

        if(currentLocationMarker){
            console.log("marker are there");
            map.removeLayer(currentLocationMarker);
        }

        //L.map('map').setView([23.788212, 90.399971], 13)
        map.setView([current_lat, current_lng]);
        currentLocationMarker = L.marker([current_lat, current_lng]).addTo(map);

        if(circle){
            circle.remove();
        }

        circle = L.circle([current_lat, current_lng], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.1,
            radius: 150
        }).addTo(map);

        //var popup = L.popup();
        

        if(ignitor == 1){
            var dis = distance(current_lat, e_lat, current_lng, e_lng);
            console.log("current distance:"+ dis);

            //popup.setLatLng([current_lat, currnt_lng]).setContent("distance between you and destination"+dis).openOn(map);

            if(dis<1){
                var alertSound = new Audio('chainsaw-04.mp3');
                alertSound.play();
            }
           
        }
            
        

        /*
        if(marker){
            map.removeLayer(marker);
            // map.removeLayer(circle);
        }
        marker = L.marker([lat, lng]).addTo(map);*/
        //circle = L.circle([lat, lng], {radius : accuracy}).addTo(map);

        //map.fitBounds(circle.getBounds())


    }

    function error(err){
        if(err.code === 1){
            alert("please allow location access");
        }
        else{
            alert("can't get location");
        }


    }

    map.on('click', onMapClick);

    var desIcon = L.icon({
    iconUrl: 'icons/desicon2.png',
    //shadowUrl: 'leaf-shadow.png',

    iconSize:     [18, 50], // size of the icon
    shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
    shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
    });

    function onMapClick(e) {
        
        e_lat = e.latlng.lat;
        e_lng = e.latlng.lng;

        if(desMarker){
            map.removeLayer(desMarker);
            // map.removeLayer(circle);
        }
        //alert("You clicked the map at " + e.latlng);
        desMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);

        ignitor = 1;

        


    }

    function distance(lat1,
                     lat2, lon1, lon2)
    {
   
        // The math module contains a function
        // named toRadians which converts from
        // degrees to radians.
        lon1 =  lon1 * Math.PI / 180;
        lon2 = lon2 * Math.PI / 180;
        lat1 = lat1 * Math.PI / 180;
        lat2 = lat2 * Math.PI / 180;
   
        // Haversine formula
        let dlon = lon2 - lon1;
        let dlat = lat2 - lat1;
        let a = Math.pow(Math.sin(dlat / 2), 2)
                 + Math.cos(lat1) * Math.cos(lat2)
                 * Math.pow(Math.sin(dlon / 2),2);
               
        let c = 2 * Math.asin(Math.sqrt(a));
   
        // Radius of earth in kilometers. Use 3956
        // for miles
        let r = 6371;
   
        // calculate the result
        return(c * r);
    }

    console.log("------------------------");


    setInterval(getLocation, 34000);

    

   

    // var popup = L.popup();

    // function onMapClick2(e) {
    //     popup
    //         .setLatLng(e.latlng)
    //         .setContent("You clicked the map at " + e.latlng.toString())
    //         .openOn(map);
    // }

    // map.on('click', onMapClick2);


</script>
</html>